@page "/register"
@inject HttpClient Http
@inject WebAuthnInterop WebAuthn

<h3 class="text-2xl font-bold mb-4 text-white">Register Credential</h3>

<input @bind="Username" placeholder="Username" class="p-2 rounded text-black" />
<button class="ml-2 bg-blue-500 text-white px-4 py-2 rounded" @onclick="RegisterAsync">Register</button>

<p class="mt-4 text-gray-300">@Status</p>

@code {
    private string Username = "david";
    private string Status = "";

    private async Task RegisterAsync()
    {
        try
        {
            Status = "Requesting credential options...";
            var options = await Http.GetFromJsonAsync<object>($"http://localhost:14555/api/user/{Username}/credential-options");

            var attestationJson = await WebAuthn.CreateCredentialAsync(options!);
            Status = "Sending attestation to server...";

            var content = new StringContent(attestationJson, System.Text.Encoding.UTF8, "application/json");
            var resp = await Http.PutAsync($"http://localhost:14555/api/user/{Username}/credential", content);
            var result = await resp.Content.ReadAsStringAsync();

            Status = $"Server response: {result}";
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
    }
}