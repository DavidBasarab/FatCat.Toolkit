@page "/login"
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime Js

<h3 class="text-2xl font-bold mb-4 text-white">Login with FIDO2</h3>

<div class="flex flex-col gap-4 bg-gray-800 ">
    <button @onclick="LoginAsync"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-40">
        Login
    </button>
</div>

@if (!string.IsNullOrEmpty(Status))
{
    <p class="mt-4 text-gray-300">@Status</p>
}

@code {


    private string Status { get; set; } = "";

    private async Task LoginAsync()
    {
        try
        {
            Status = "Requesting assertion options...";

            // Step 1: Get assertion options
            var optionsResponse =
                await Http.GetFromJsonAsync<JsonElement>($"http://localhost:14555/api/user/assertion-options");

            // Step 2: Use WebAuthn to sign in
            Status = "Authenticating...";

            var assertion = await Js.InvokeAsync<JsonElement>(
                                                              "getAssertion",
                                                              JsonSerializer.Serialize(optionsResponse)
                                                             );

            // Step 3: Send to server
            var result = await Http.PostAsJsonAsync(
                                                    "http://localhost:14555/api/user/assertion",
                                                    assertion
                                                   );

            var token = await result.Content.ReadAsStringAsync();

            if (token.StartsWith("Bearer")) Status = "✅ Login successful!";
            else Status = $"❌ Login failed: {token}";
        }
        catch (Exception ex)
        {
            Status = $"⚠️ Error: {ex.Message}";
            Console.WriteLine(ex);
        }
    }


}