@page "/register"
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JS

<h3>Register User</h3>

<input placeholder="Username" @bind="Username"/>
<button class="btn btn-primary" @onclick="RegisterAsync">Register</button>

<p>@Message</p>

@code {

    private string Username { get; set; } = "";


    private string Message { get; set; } = "";

    private async Task RegisterAsync()
    {
        Message = "Requesting credential options...";

        // get credential options from API
        var options = await Http.GetFromJsonAsync<object>(
                                                          $"api/user/{Username}/credential-options?attestationType=None&userVerification=required");

        var optionsJson = JsonSerializer.Serialize(options);

        // create WebAuthn credential via interop
        var credJson = await JS.InvokeAsync<string>("webauthnInterop.createCredential", optionsJson);

        // send credential back to API to register
        var response = await Http.PutAsJsonAsync(
                                                 $"api/user/{Username}/credential",
                                                 JsonSerializer.Deserialize<object>(credJson)!);

        if (response.IsSuccessStatusCode) Message = "✅ Registration complete!";
        else Message = $"❌ Error: {await response.Content.ReadAsStringAsync()}";
    }


}