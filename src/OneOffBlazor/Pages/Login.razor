@page "/login"
@inject HttpClient Http
@inject WebAuthnInterop WebAuthn

<h3 class="text-2xl font-bold mb-4 text-white">Login with Passkey</h3>

<input @bind="Username" placeholder="Username" class="p-2 rounded text-black" />
<button class="ml-2 bg-green-600 text-white px-4 py-2 rounded" @onclick="LoginAsync">Login</button>

<p class="mt-4 text-gray-300">@Status</p>

@code {
    private string Username = "david";
    private string Status = "";

    private async Task LoginAsync()
    {
        try
        {
            Status = "Requesting assertion options...";
            var options = await Http.GetFromJsonAsync<object>($"http://localhost:14555/api/user/{Username}/assertion-options");

            var assertionJson = await WebAuthn.GetAssertionAsync(options!);
            Status = "Verifying with server...";

            var content = new StringContent(assertionJson, System.Text.Encoding.UTF8, "application/json");
            var resp = await Http.PostAsync("http://localhost:14555/api/user/assertion", content);
            var token = await resp.Content.ReadAsStringAsync();

            Status = $"Server response: {token}";
        }
        catch (Exception ex)
        {
            Status = $"Error: {ex.Message}";
        }
    }
}